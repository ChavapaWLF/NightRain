# 🌙 彩色雨夜荷塘 - 高级3D特效版 (NightRain)

一个使用C语言和SDL2开发的美丽夜雨荷塘景色模拟程序，具有高级3D特效、动态天气系统和真实物理效果。

## 📖 项目简介

这是一个高度沉浸式的雨夜荷塘模拟器，展现了在夜晚月光下的美丽荷塘景色。程序包含了复杂的物理系统、天气变化、3D深度感知和丰富的视觉特效，创造出令人惊叹的视觉体验。

## ✨ 主要特性

### 🌧️ 动态天气系统
- **四种天气模式**：
  - 和风细雨 - 宁静柔和的细雨
  - 中雨 - 适中的降雨强度
  - 暴风骤雨 - 狂风大作的暴雨
  - 电闪雷鸣 - 雷电交加的暴风雨

### 🎭 3D视觉特效
- **真实的3D景深**：使用Z轴坐标系统模拟远近效果
- **透视投影**：远处物体更小，近处物体更大
- **深度颜色调整**：远处物体颜色更暗，营造真实的大气透视效果
- **层次化渲染**：背景山峦、中景荷塘、前景雨滴的层次感

### 🌊 物理仿真系统
- **真实的雨滴物理**：
  - 重力影响下的自然下落
  - 风力对雨滴轨迹的影响
  - 雨滴与荷叶的碰撞检测
  - 雨滴入水后的涟漪效果

- **荷叶水珠溅射**：雨滴打在荷叶上产生的水珠飞溅效果
- **动态涟漪系统**：雨滴入水后产生的同心圆涟漪扩散

### 🎨 丰富的视觉元素
- **星空背景**：300颗闪烁的星星
- **月亮光影**：动态的月光效果
- **层次云彩**：7层云彩系统营造天空深度
- **远山剪影**：5座不同高度的山峦
- **荷塘生态**：
  - 25片动态荷叶，具有波动和倾斜效果
  - 8朵荷花，随风轻摆
  - 20根芦苇，自然摇摆
- **闪电特效**：真实的闪电路径和分支效果

### 🎵 音效系统
- **背景音乐**：循环播放的雨夜环境音
- **水滴声效**：雨滴入水的声音
- **雷声效果**：雷电的轰隆声

### 📊 性能监控
- 实时FPS显示
- 物理计算耗时统计
- 渲染耗时分析
- 输入处理性能监控

## 🎮 操作控制

### 天气控制
- `1` - 切换到和风细雨模式
- `2` - 切换到中雨模式
- `3` - 切换到暴风骤雨模式
- `4` - 切换到电闪雷鸣模式

### 强度调节
- `↑` - 增加天气强度
- `↓` - 减少天气强度

### 视角控制
- `←` - 向左移动摄像机
- `→` - 向右移动摄像机
- `Home` - 重置摄像机位置

### 特效控制
- `空格` - 手动触发闪电和雷声
- `ESC` - 退出程序

## 🔧 技术实现

### 核心架构
```
NightRain.c (2079行)
├── 数据结构定义 (结构体)
├── 全局变量和状态管理
├── 初始化系统
├── 物理更新系统
├── 渲染系统
└── 事件处理系统
```

### 关键数据结构
- `Raindrop` - 雨滴对象，包含3D坐标、速度、颜色等
- `Ripple` - 涟漪对象，具有扩散半径和生命周期
- `Splash` - 溅射水珠对象
- `Lightning` - 闪电对象，包含路径点和分支
- `LotusPad` - 荷叶对象，具有波动和纹理
- `LotusFlower` - 荷花对象
- `WeatherState` - 天气状态枚举

### 性能优化
- 使用纹理缓存减少重复渲染
- 对象池管理避免频繁内存分配
- 深度排序优化渲染顺序
- 屏幕外剔除减少不必要的计算

## 🏗️ 构建说明

### 系统要求
- Windows 10 或更高版本
- MinGW-w64 GCC 编译器
- SDL2 开发库
- SDL2_mixer 音频库

### 依赖库
- **SDL2** - 跨平台图形和音频库
- **SDL2_mixer** - 音频混音库
- **Windows API** - 控制台和字符编码支持

### 编译步骤

1. **安装 MinGW-w64**
   ```bash
   # 下载并安装到 C:\Program Files (x86)\mingw64\
   ```

2. **安装 SDL2 库**
   ```bash
   # 将SDL2开发库解压到MinGW目录
   # 或者通过包管理器安装
   ```

3. **编译项目**
   ```bash
   gcc -g NightRain.c -o NightRain.exe -lmingw32 -lSDL2main -lSDL2 -lSDL2_mixer -mwindows
   ```

4. **运行程序**
   ```bash
   ./NightRain.exe
   ```

### VSCode 配置
项目包含了完整的 VSCode 配置文件：
- `.vscode/tasks.json` - 构建任务配置
- `.vscode/launch.json` - 调试配置
- `.vscode/c_cpp_properties.json` - C/C++ 智能提示配置

## 📁 项目结构

```
NightRain/
├── NightRain.c          # 主源代码文件 (2079行)
├── NightRain.exe        # 编译后的可执行文件
├── SDL2.dll             # SDL2运行时库
├── SDL2_mixer.dll       # SDL2_mixer运行时库
├── audio/               # 音频资源文件夹
│   ├── bgm.mp3         # 背景音乐
│   ├── lightning.wav   # 雷声音效
│   └── splash.wav      # 水滴音效
├── .vscode/            # VSCode配置文件
│   ├── c_cpp_properties.json
│   ├── launch.json
│   └── tasks.json
├── LICENSE             # MIT许可证
└── README.md          # 项目文档
```

## 🎯 核心算法

### 3D投影算法
```c
float project_x(float x, float z) {
    return x + camera_x + (x - WINDOW_WIDTH/2) * z * 0.3f;
}

float get_z_scale(float z) {
    return 0.5f + 0.5f * z;  // 远处缩小，近处放大
}
```

### 物理仿真
- **重力加速度**：`RAINDROP_FALL_SPEED_MIN` 到 `RAINDROP_FALL_SPEED_MAX`
- **风力影响**：水平速度 = `wind_strength * 风力系数`
- **碰撞检测**：雨滴与荷叶的圆形碰撞检测

### 天气系统
- **自动天气变化**：每50-100秒随机切换天气
- **强度渐变**：天气强度平滑过渡
- **风力模拟**：风力强度影响雨滴轨迹和植物摆动

## 🎨 视觉效果详解

### 颜色系统
- **深度着色**：根据Z坐标调整物体颜色亮度
- **彩色雨滴**：随机生成的彩色雨滴
- **动态光照**：闪电会照亮雨滴和场景

### 动画效果
- **星星闪烁**：基于时间的亮度变化
- **荷叶波动**：正弦波模拟水面波动
- **芦苇摇摆**：风力驱动的自然摆动
- **云彩移动**：多层云彩的差速移动

## 📈 性能特性

### 帧率控制
- 目标帧率：60 FPS
- 垂直同步：防止画面撕裂
- 性能监控：实时显示渲染耗时

### 内存管理
- **对象池**：预分配雨滴、涟漪等对象
- **纹理缓存**：荷叶纹理动态生成和缓存
- **智能清理**：超时对象自动回收

### 优化策略
- **屏幕剔除**：只渲染屏幕内的对象
- **深度排序**：按Z坐标排序渲染
- **批量操作**：减少SDL渲染调用次数

## 🛠️ 开发环境

### 推荐配置
- **编辑器**：Visual Studio Code
- **编译器**：MinGW-w64 GCC
- **调试器**：GDB
- **版本控制**：Git

### 扩展建议
- C/C++ 语言支持
- Code Runner 快速运行
- GitLens Git增强

## 📄 许可证

本项目采用 MIT 许可证，详见 [LICENSE](LICENSE) 文件。

## 👨‍💻 作者

**Chavapa** - 项目创建者和主要开发者

## 🌟 致谢

感谢以下开源项目的支持：
- [SDL2](https://www.libsdl.org/) - 跨平台多媒体库
- [SDL2_mixer](https://www.libsdl.org/projects/SDL_mixer/) - 音频混音库
- [MinGW-w64](https://www.mingw-w64.org/) - Windows下的GCC编译器

---

*享受这个美丽的雨夜荷塘吧！* 🌙✨
